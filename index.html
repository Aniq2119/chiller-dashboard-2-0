<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiller Monitoring Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --color-primary: #BB86FC;
            --color-secondary: #03DAC5;
            --color-background: #0A0F1A;
            --color-surface: #1A2333;
            --color-on-primary: #000000;
            --color-on-secondary: #000000;
            --color-on-background: #E0E0E0;
            --color-on-surface: #E0E0E0;
            --color-on-surface-variant: rgba(224, 224, 224, 0.7);
            --color-error: #CF6679;
            --color-surface-alpha-06: rgba(26, 35, 51, 0.6);
            --color-surface-alpha-03: rgba(26, 35, 51, 0.3);
            --color-grid: rgba(224, 224, 224, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-on-background);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .background-gradient {
            background: linear-gradient(135deg, var(--color-background) 0%, var(--color-surface) 50%, var(--color-background) 100%);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .card-surface-gradient {
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.5) 0%, rgba(26, 35, 51, 0.7) 100%);
        }

        .dashboard-card {
            background-color: transparent;
            border-radius: 0.75rem; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-button {
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: var(--color-on-surface-variant);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }
        
        .sim-button, .gemini-button {
            background-color: var(--color-surface);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sim-button:hover, .gemini-button:hover {
            background-color: var(--color-primary);
            color: var(--color-on-primary);
        }
        .sim-button:disabled, .gemini-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chiller-status-circle {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid;
            box-sizing: border-box; 
        }

        .chiller-status-circle.running::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            border: 2px dashed var(--color-primary);
            animation: spin-border 4s linear infinite;
        }
        
        @keyframes spin-border {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--color-surface);
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
        }
        #gemini-response pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Inter', sans-serif;
            color: var(--color-on-surface);
        }
        /* Simple spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col">
    <div class="background-gradient"></div>
    <!-- Header -->
    <header class="bg-[var(--color-surface-alpha-06)] p-4 shadow-lg z-10">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Chiller Dashboard <span class="text-[var(--color-primary)]">2.0</span></h1>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="bg-[var(--color-surface-alpha-03)] shadow-md z-10">
        <div class="container mx-auto flex justify-between items-center">
            <div id="tabs-container" class="relative flex overflow-x-auto">
                <button class="tab-button active flex-shrink-0" onclick="selectTab(0, this)">System Status</button>
                <button class="tab-button flex-shrink-0" onclick="selectTab(1, this)">Home</button>
                <button class="tab-button flex-shrink-0" onclick="selectTab(2, this)">Metrics & Chart</button>
                <button class="tab-button flex-shrink-0" onclick="selectTab(3, this)">Cooling Demand Table</button>
            </div>
             <!-- Mode Switch -->
            <div class="flex items-center space-x-2 p-2 md:p-0">
                <span id="mode-text" class="text-[var(--color-on-surface)] text-sm font-medium">Mode: Daily Simulation</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="mode-switch" class="sr-only peer">
                    <div class="w-11 h-6 bg-[var(--color-surface-alpha-03)] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[var(--color-primary)]"></div>
                </label>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto p-6 md:p-10 relative z-0">
        <div id="tab-content-0" class="tab-content">
            <!-- System Status Content -->
             <section class="mb-8 text-center">
                <h2 class="text-xl font-semibold mb-4">Real-Time Chiller Status</h2>
                <div class="flex flex-wrap justify-center gap-6">
                    <div class="chiller-status-circle flex flex-col items-center justify-center bg-[var(--color-surface-alpha-03)]" id="chiller1-status">
                        <span class="text-sm font-medium">Chiller 1</span>
                        <span class="text-xs" id="chiller1-status-text">OFF</span>
                    </div>
                    <div class="chiller-status-circle flex flex-col items-center justify-center bg-[var(--color-surface-alpha-03)]" id="chiller2-status">
                        <span class="text-sm font-medium">Chiller 2</span>
                        <span class="text-xs" id="chiller2-status-text">STANDBY</span>
                    </div>
                    <div class="chiller-status-circle flex flex-col items-center justify-center bg-[var(--color-surface-alpha-03)]" id="chiller3-status">
                        <span class="text-sm font-medium">Chiller 3</span>
                        <span class="text-xs" id="chiller3-status-text">OFF</span>
                    </div>
                </div>
            </section>
             <section class="text-center mb-8">
                <h2 class="text-xl font-semibold mb-4">Status Indicators</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="dashboard-card card-surface-gradient text-center">
                        <h3 class="text-lg font-medium mb-2 text-[var(--color-on-surface-variant)]">Current Load (%)</h3>
                        <p class="text-[var(--color-primary)] text-4xl font-bold" id="current-load-percent">--%</p>
                    </div>
                    <div class="dashboard-card card-surface-gradient text-center">
                        <h3 class="text-lg font-medium mb-2 text-[var(--color-on-surface-variant)]">Cooling Output (RT)</h3>
                        <p class="text-[var(--color-primary)] text-4xl font-bold" id="cooling-output-rt">--</p>
                    </div>
                    <div class="dashboard-card card-surface-gradient text-center">
                        <h3 class="text-lg font-medium mb-2 text-[var(--color-on-surface-variant)]">Power Usage (kW)</h3>
                        <p class="text-[var(--color-primary)] text-4xl font-bold" id="power-usage-kw">--</p>
                    </div>
                </div>
            </section>
        </div>
        <div id="tab-content-1" class="tab-content hidden">
            <!-- Home Tab Content -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                 <!-- Left Column -->
                <div class="space-y-8">
                    <section class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="dashboard-card card-surface-gradient flex flex-row items-center">
                            <i data-lucide="snowflake" class="text-[var(--color-secondary)] w-8 h-8 mr-4 flex-shrink-0"></i>
                            <div>
                                <h3 class="text-lg font-medium text-[var(--color-on-surface-variant)]">Total Cooling Load (RT)</h3>
                                <p class="text-3xl font-bold text-[var(--color-on-surface)]" id="home-cooling-load">--</p>
                            </div>
                        </div>
                        <div class="dashboard-card card-surface-gradient flex flex-row items-center">
                            <i data-lucide="zap" class="text-[var(--color-secondary)] w-8 h-8 mr-4 flex-shrink-0"></i>
                            <div>
                                <h3 class="text-lg font-medium text-[var(--color-on-surface-variant)]">Total Power Usage (kW)</h3>
                                <p class="text-3xl font-bold text-[var(--color-on-surface)]" id="home-power-usage">--</p>
                            </div>
                        </div>
                    </section>
                    
                    <div>
                        <h2 class="text-xl font-semibold mb-4 text-center">Individual Chiller Performance</h2>
                        <section class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <div class="dashboard-card card-surface-gradient p-4 space-y-4 text-center">
                                <div class="flex items-center justify-center">
                                    <i data-lucide="factory" class="text-[var(--color-primary)] w-6 h-6 mr-2"></i>
                                    <h3 class="text-lg font-medium text-[var(--color-on-surface-variant)]">Chiller 1</h3>
                                </div>
                                <div>
                                    <p class="text-sm text-[var(--color-on-surface-variant)]">Load (RT)</p>
                                    <p class="text-2xl font-bold" id="chiller1-load">--</p>
                                </div>
                                <div>
                                     <p class="text-sm text-[var(--color-on-surface-variant)]">Power (kW)</p>
                                    <p class="text-2xl font-bold" id="chiller1-power">--</p>
                                </div>
                            </div>
                            <div class="dashboard-card card-surface-gradient p-4 space-y-4 text-center">
                               <div class="flex items-center justify-center">
                                    <i data-lucide="factory" class="text-[var(--color-primary)] w-6 h-6 mr-2"></i>
                                    <h3 class="text-lg font-medium text-[var(--color-on-surface-variant)]">Chiller 2</h3>
                                </div>
                                <div>
                                    <p class="text-sm text-[var(--color-on-surface-variant)]">Load (RT)</p>
                                    <p class="text-2xl font-bold" id="chiller2-load">--</p>
                                </div>
                                <div>
                                     <p class="text-sm text-[var(--color-on-surface-variant)]">Power (kW)</p>
                                    <p class="text-2xl font-bold" id="chiller2-power">--</p>
                                </div>
                            </div>
                            <div class="dashboard-card card-surface-gradient p-4 space-y-4 text-center">
                                <div class="flex items-center justify-center">
                                    <i data-lucide="factory" class="text-[var(--color-primary)] w-6 h-6 mr-2"></i>
                                    <h3 class="text-lg font-medium text-[var(--color-on-surface-variant)]">Chiller 3</h3>
                                </div>
                                <div>
                                    <p class="text-sm text-[var(--color-on-surface-variant)]">Load (RT)</p>
                                    <p class="text-2xl font-bold" id="chiller3-load">--</p>
                                </div>
                                <div>
                                     <p class="text-sm text-[var(--color-on-surface-variant)]">Power (kW)</p>
                                    <p class="text-2xl font-bold" id="chiller3-power">--</p>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
                <!-- Right Column -->
                <div class="lg:col-span-1">
                     <h2 class="text-xl font-semibold mb-4 text-center">Chiller Load Distribution</h2>
                     <div class="dashboard-card card-surface-gradient flex flex-col items-center justify-center p-4">
                         <p id="donut-subtitle" class="text-sm text-center text-[var(--color-on-surface-variant)] mb-2"></p>
                        <div class="relative h-96 w-full">
                           <canvas id="loadDistributionChart"></canvas>
                        </div>
                     </div>
                </div>
            </div>
        </div>
        <div id="tab-content-2" class="tab-content hidden">
            <!-- Metrics & Chart Tab Content -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold mb-4">Key Performance Indicators</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="dashboard-card card-surface-gradient">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center"><i data-lucide="gauge" class="text-[var(--color-secondary)] w-8 h-8 mr-4 flex-shrink-0"></i><div><h3 class="text-base text-[var(--color-on-surface-variant)]">Plant Efficiency</h3><p class="text-2xl font-bold" id="kpi-efficiency">-- kW/RT</p></div></div>
                            <button id="get-kpi-insights-btn" class="gemini-button !p-2 !border-0"><i data-lucide="sparkles"></i></button>
                        </div>
                    </div>
                    <div class="dashboard-card card-surface-gradient flex items-center"><i data-lucide="thermometer" class="text-[var(--color-secondary)] w-8 h-8 mr-4 flex-shrink-0"></i><div><h3 class="text-base text-[var(--color-on-surface-variant)]">Avg. Cooling Load</h3><p class="text-2xl font-bold" id="kpi-avg-load">-- RT</p></div></div>
                    <div class="dashboard-card card-surface-gradient flex items-center"><i data-lucide="trending-up" class="text-[var(--color-secondary)] w-8 h-8 mr-4 flex-shrink-0"></i><div><h3 class="text-base text-[var(--color-on-surface-variant)]">Peak Cooling Load</h3><p class="text-2xl font-bold" id="kpi-peak-load">-- RT</p></div></div>
                    <div class="dashboard-card card-surface-gradient flex items-center"><i data-lucide="bolt" class="text-[var(--color-secondary)] w-8 h-8 mr-4 flex-shrink-0"></i><div><h3 class="text-base text-[var(--color-on-surface-variant)]">Avg. Power Usage</h3><p class="text-2xl font-bold" id="kpi-avg-power">-- kW</p></div></div>
                </div>
            </section>
             <section class="mb-8">
                <div class="dashboard-card card-surface-gradient p-4">
                    <div class="w-full mx-auto h-[60vh]"><canvas id="dailyPerformanceChart"></canvas></div>
                    <div class="flex justify-center items-center mt-8 text-sm space-x-4">
                       <button id="play-pause-button" class="sim-button">Play Simulation</button>
                       <button id="reset-button" class="sim-button" style="background-color: #6c757d; border-color: #6c757d;">Reset</button>
                       <button id="analyze-performance-btn" class="gemini-button">✨ Analyze Performance</button>
                    </div>
                </div>
            </section>
        </div>
        <div id="tab-content-3" class="tab-content hidden">
            <!-- Cooling Demand Table Content -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold mb-4 text-center">Cooling Demand Table</h2>
                <div class="dashboard-card card-surface-gradient overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium uppercase text-[var(--color-on-surface-variant)]">Cooling Demand (RT)</th>
                                <th class="py-3 px-4 text-left text-xs font-medium uppercase text-[var(--color-on-surface-variant)]">Evap Entering (°C)</th>
                                <th class="py-3 px-4 text-left text-xs font-medium uppercase text-[var(--color-on-surface-variant)]">Evap Leaving (°C)</th>
                            </tr>
                        </thead>
                        <tbody id="cooling-demand-table-body" class="divide-y divide-gray-700">
                            <tr><td colspan="3" class="text-center py-4">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Gemini Modal -->
    <div id="gemini-modal" class="modal-overlay">
        <div class="modal-content card-surface-gradient">
            <button class="modal-close-btn" onclick="hideGeminiModal()">
                <i data-lucide="x" class="text-[var(--color-on-surface-variant)]"></i>
            </button>
            <h2 id="gemini-modal-title" class="text-xl font-bold mb-4 text-[var(--color-primary)]">AI Insights</h2>
            <div id="gemini-response-container">
                <div class="spinner hidden"></div>
                <div id="gemini-response"><pre></pre></div>
            </div>
        </div>
    </div>


    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 p-4 text-center text-sm z-10 mt-auto">
        <div class="container mx-auto">&copy; 2025 Chiller Monitoring System.</div>
    </footer>

    <script>
        var chillerDataUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGxKeWAmp1w2vjkQE0tQJKLdm4ZzwLsKgpxRRJUmUerdwnvgXgk2K2XnVKSqwdlEmGSm8NPy9fi_9v/pub?output=csv";
        var chillerManualDataUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTR3MeUBIM52Nv9zn2fQB0ZHWBCubIkRU8AuE5voSHKZGdXgiTGYkD2Vc4JLKpYEMl7oWau--fLRkTb/pub?output=csv";
        var coolingDemandUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmEQNOaibA1Mbe-3nNWvQPrtDWwIoueQs1FaXuj3UDznWCrI17WE1_rUMdUVHS6RN29NyEPNbhINt2/pub?output=csv";
        let sheetData = [], demandTable = [], dailyPerformanceChartInstance = null, loadDistributionChartInstance = null, animationInterval = null, currentDataIndex = 0, isAnimationPlaying = false, isManualMode = false;
        var simulationCsvContent = `Time,EWT_Celsius,out_C1Load,out_C2Load,out_C3Load,out_C1Power,out_C2Power,out_C3Power,out_TotalCoolingLoad,out_TotalPower_Default,out_TotalPower_GAMBO
8:00 AM,9.47,269.13538262,203.51718317,283.34743404,194.266342997757,151.251118557847,184.247979503058,755.99999983,563.46,529.77
9:00 AM,9.83,268.22831245,203.54230543,338.22938234,194.254050423959,151.272634354727,182.727557986051,810.00000022,580.56,528.25
10:00 AM,10.19,285.936592,238.06353261,339.99987522,200.769864330564,177.873206934523,182.749997908137,863.99999983,607.8,561.39
11:00 AM,10.76,284.44838429,293.55165598,339.99995988,199.7660668439,214.224992647254,182.749999327404,918.00000015,642.35,596.74
12:00 PM,11.53,289.64976733,342.35046092,339.99977186,203.580128452979,249.112309984504,182.749996175423,972.00000011,678.78,635.44
1:00 PM,12.27,316.00109037,369.99943168,339.99947776,232.482123445882,273.819439361205,182.749991245443,1025.99999981,714.42,689.05
2:00 PM,13.05,370,370,340,288.5,273.82,182.75,1080,750.06,745.07
3:00 PM,11.53,289.64976733,342.35046092,339.99977186,203.580128452979,249.112309984504,182.749996175423,972.00000011,678.78,635.44
4:00 PM,10.19,285.936592,238.06353261,339.99987522,200.769864330564,177.873206934523,182.749997908137,863.99999983,607.8,561.39
5:00 PM,9.83,268.22831245,203.54230543,338.22938234,194.254050423959,151.272634354727,182.727557986051,810.00000022,580.56,528.25`;
        
        // --- Gemini API ---
        async function callGeminiAPI(prompt) {
            const modalTitle = document.getElementById('gemini-modal-title');
            const responseEl = document.getElementById('gemini-response').querySelector('pre');
            const spinner = document.querySelector('.spinner');

            showGeminiModal();
            spinner.classList.remove('hidden');
            responseEl.textContent = '';
            
            const apiKey = ""; // Keep this empty
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                const result = await response.json();
                
                let text = "Sorry, I couldn't get a response. Please try again.";
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    text = result.candidates[0].content.parts[0].text;
                }
                responseEl.textContent = text;

            } catch (error) {
                console.error("Gemini API call failed:", error);
                responseEl.textContent = `Error: Could not retrieve insights. ${error.message}`;
            } finally {
                spinner.classList.add('hidden');
            }
        }

        function showGeminiModal() { document.getElementById('gemini-modal').classList.add('visible'); }
        function hideGeminiModal() { document.getElementById('gemini-modal').classList.remove('visible'); }

        function handlePerformanceAnalysis() {
            const prompt = `
                As an expert HVAC analyst, review the following chiller performance data from a simulation.
                The data compares the power consumption of a 'Default Setting' against an optimized 'GA-BMO' setting.

                Data:
                ${simulationCsvContent}

                Based on this data, provide a concise report covering these points:
                1.  **Performance Summary:** Briefly summarize the overall performance difference. Which setting was more efficient?
                2.  **Peak Hours Analysis:** Identify the hour with the highest consumption for both settings and state the difference.
                3.  **Key Recommendations:** Provide two actionable recommendations for the building manager to save energy, based on these findings.

                Format the response clearly with headings for each section.
            `;
            document.getElementById('gemini-modal-title').textContent = "Performance Analysis Report";
            callGeminiAPI(prompt);
        }

        function handleKpiInsights() {
            const efficiencyValue = document.getElementById('kpi-efficiency').textContent;
            if (!efficiencyValue || efficiencyValue.includes('--')) {
                alert("Please wait for KPI data to load before getting insights.");
                return;
            }
            const prompt = `
                A chiller plant's current efficiency is ${efficiencyValue}. 
                As an HVAC expert, please explain what this number means in simple terms for a building manager.
                - Is this generally considered good or poor efficiency? (Assume a good range is 0.5-0.7 kW/RT).
                - What are two common reasons that could lead to this efficiency level?
            `;
             document.getElementById('gemini-modal-title').textContent = "Plant Efficiency Insights";
            callGeminiAPI(prompt);
        }
        
        // --- Core Dashboard Functions ---
        function parseCsvData(csvText) {
            try {
                const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
                if (lines.length < 2) return [];
                const headers = lines[0].split(',').map(h => h.trim());
                return lines.slice(1).map(line => {
                    const values = line.split(',');
                    return headers.reduce((obj, header, index) => {
                        obj[header] = values[index] ? values[index].trim() : '';
                        return obj;
                    }, {});
                }).filter(row => row);
            } catch (e) { return []; }
        }
        
        async function fetchCsvData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) return [];
                const csvText = await response.text();
                return parseCsvData(csvText);
            } catch (e) { return []; }
        }
        
        async function fetchChillerData() {
            const url = isManualMode ? chillerManualDataUrl : chillerDataUrl;
            sheetData = await fetchCsvData(url);
            updateAllTabs();
        }

        function updateAllTabs() {
            updateSystemStatusTab();
            updateHomeTab();
            updateMetricsTab();
            updateCoolingDemandTableTab();
            if(document.getElementById('tab-content-1').offsetParent !== null) {
                 setupLoadDistributionChart();
            }
        }

        function updateSystemStatusTab() {
            const latestData = sheetData[sheetData.length - 1] || {};
            const getStatus = (power) => {
                const p = parseFloat(power);
                if (isNaN(p) || p <= 0) return { text: "OFF", color: "var(--color-secondary)", running: false };
                if (p > 1.0) return { text: "RUNNING", color: "var(--color-primary)", running: true };
                return { text: "STANDBY", color: "var(--color-secondary)", running: false };
            };
            
            ['1', '2', '3'].forEach(i => {
                const status = getStatus(latestData[`out_C${i}Power`]);
                const circle = document.getElementById(`chiller${i}-status`);
                const text = document.getElementById(`chiller${i}-status-text`);
                if (circle && text) {
                    circle.style.borderColor = status.color;
                    text.textContent = status.text;
                    status.running ? circle.classList.add('running') : circle.classList.remove('running');
                }
            });

            const totalLoad = parseFloat(latestData["out_TotalCoolingLoad"]) || 0;
            const totalPower = parseFloat(latestData["out_TotalPower_GAMBO"] || latestData["out_TotalPower_Default"]) || 0;
            const maxPlantLoad = 1080.0;
            document.getElementById('current-load-percent').textContent = `${((totalLoad / maxPlantLoad) * 100).toFixed(1)}%`;
            document.getElementById('cooling-output-rt').textContent = totalLoad.toFixed(1);
            document.getElementById('power-usage-kw').textContent = totalPower.toFixed(2);
        }

        function updateHomeTab() {
            const latest = sheetData[sheetData.length - 1] || {};
            document.getElementById('home-cooling-load').textContent = (parseFloat(latest["out_TotalCoolingLoad"]) || 0).toFixed(2);
            document.getElementById('home-power-usage').textContent = (parseFloat(latest["out_TotalPower_GAMBO"] || latest["out_TotalPower_Default"]) || 0).toFixed(2);
            ['1', '2', '3'].forEach(i => {
                document.getElementById(`chiller${i}-load`).textContent = `${(parseFloat(latest[`out_C${i}Load`]) || 0).toFixed(2)}`;
                document.getElementById(`chiller${i}-power`).textContent = `${(parseFloat(latest[`out_C${i}Power`]) || 0).toFixed(2)}`;
            });
        }
        
        function updateMetricsTab() {
            if (sheetData.length === 0) return;
            const latest = sheetData[sheetData.length - 1];
            const totalPower = parseFloat(latest["out_TotalPower_GAMBO"] || latest["out_TotalPower_Default"]) || 0;
            const totalLoad = parseFloat(latest["out_TotalCoolingLoad"]) || 0;
            document.getElementById('kpi-efficiency').textContent = totalLoad > 0 ? `${(totalPower / totalLoad).toFixed(2)} kW/RT` : 'N/A';

            const loads = sheetData.map(r => parseFloat(r["out_TotalCoolingLoad"])).filter(v => !isNaN(v));
            const powers = sheetData.map(r => parseFloat(r["out_TotalPower_GAMBO"] || r["out_TotalPower_Default"])).filter(v => !isNaN(v));
            
            if (loads.length > 0) {
                document.getElementById('kpi-avg-load').textContent = `${(loads.reduce((a, b) => a + b, 0) / loads.length).toFixed(2)} RT`;
                document.getElementById('kpi-peak-load').textContent = `${Math.max(...loads).toFixed(2)} RT`;
            }
            if (powers.length > 0) {
                 document.getElementById('kpi-avg-power').textContent = `${(powers.reduce((a, b) => a + b, 0) / powers.length).toFixed(2)} kW`;
            }
        }

        function updateCoolingDemandTableTab() {
            const tbody = document.getElementById('cooling-demand-table-body');
            tbody.innerHTML = '';
            if (demandTable.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4">No data available</td></tr>`;
                return;
            }
            demandTable.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-[var(--color-surface)]';
                tr.innerHTML = `
                    <td class="py-3 px-4">${(parseFloat(row["CoolingDemandRT"]) || 0).toFixed(2)}</td>
                    <td class="py-3 px-4">${(parseFloat(row["EvapEnteringWaterTemp"]) || 0).toFixed(2)}</td>
                    <td class="py-3 px-4">${(parseFloat(row["EvapLeavingWaterTemp"]) || 0).toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function setupLoadDistributionChart() {
            const ctx = document.getElementById('loadDistributionChart');
            if(!ctx) return;
            const latestData = sheetData[sheetData.length - 1] || {};
            const loads = [
                parseFloat(latestData['out_C1Load'] || 0),
                parseFloat(latestData['out_C2Load'] || 0),
                parseFloat(latestData['out_C3Load'] || 0)
            ];
            const totalLoad = loads.reduce((a, b) => a + b, 0);
            
            document.getElementById('donut-subtitle').textContent = `Current Hour | Share of Total Load (${totalLoad.toFixed(2)} RT)`;

            const data = {
                labels: ['Chiller 1', 'Chiller 2', 'Chiller 3'],
                datasets: [{
                    data: loads,
                    backgroundColor: [ '#BB86FC', '#03DAC5', '#CF6679' ],
                    borderColor: '#0A0F1A',
                    borderWidth: 2,
                    offset: loads.map(load => load === Math.max(...loads) ? 10 : 0),
                }]
            };

            const centerTextPlugin = {
                id: 'centerText',
                afterDraw: (chart) => {
                    const {ctx, chartArea: {top, bottom, left, right, width, height}} = chart;
                    ctx.save();
                    ctx.font = 'bold 24px Inter';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#E0E0E0';
                    ctx.fillText(`${totalLoad.toFixed(1)}`, width / 2, top + (height / 2) - 10);
                    ctx.font = '14px Inter';
                    ctx.fillStyle = 'rgba(224, 224, 224, 0.7)';
                    ctx.fillText('Total RT', width / 2, top + (height / 2) + 15);
                    ctx.restore();
                }
            };
            
            if(loadDistributionChartInstance) {
                loadDistributionChartInstance.data = data;
                loadDistributionChartInstance.options.plugins.legend.labels.generateLabels = function(chart) {
                     const data = chart.data;
                     if (data.labels.length && data.datasets.length) {
                         const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                         return data.labels.map((label, i) => {
                             const meta = chart.getDatasetMeta(0);
                             const style = meta.controller.getStyle(i);
                             const value = chart.data.datasets[0].data[i];
                             const percentage = total > 0 ? (value / total * 100).toFixed(1) + '%' : '0.0%';
                             return {
                                 text: `${label} (${percentage})`,
                                 fillStyle: style.backgroundColor,
                                 strokeStyle: style.borderColor,
                                 lineWidth: style.borderWidth,
                                 hidden: isNaN(value) || meta.data[i].hidden,
                                 index: i
                             };
                         });
                     }
                     return [];
                };
                loadDistributionChartInstance.update();
                return;
            }
            
            Chart.register(ChartDataLabels);

            loadDistributionChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                plugins: [centerTextPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        datalabels: {
                            color: '#fff',
                            formatter: (value, context) => {
                                 if (value < (totalLoad * 0.10)) return ''; // Hide label if slice is less than 10%
                                return value > 0 ? value.toFixed(1) : '';
                            },
                            font: { weight: 'bold', size: 12 },
                            align: 'center',
                            anchor: 'center',
                        },
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: 'rgba(224, 224, 224, 0.7)',
                                boxWidth: 15,
                                padding: 20,
                                generateLabels: function(chart) {
                                     const data = chart.data;
                                     if (data.labels.length && data.datasets.length) {
                                         const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                         return data.labels.map((label, i) => {
                                             const meta = chart.getDatasetMeta(0);
                                             const style = meta.controller.getStyle(i);
                                             const value = chart.data.datasets[0].data[i];
                                             const percentage = total > 0 ? (value / total * 100).toFixed(1) + '%' : '0.0%';
                                             return {
                                                 text: `${label} (${percentage})`,
                                                 fillStyle: style.backgroundColor,
                                                 strokeStyle: style.borderColor,
                                                 lineWidth: style.borderWidth,
                                                 hidden: isNaN(value) || meta.data[i].hidden,
                                                 index: i
                                             };
                                         });
                                     }
                                     return [];
                                }
                            }
                        },
                         tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const percentage = (value / totalLoad * 100).toFixed(1) + '%';
                                    return `${label}: ${value.toFixed(2)} RT (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function setupAnimatedChart() {
            const ctx = document.getElementById('dailyPerformanceChart');
            const simulationLogData = parseCsvData(simulationCsvContent);
            if (!ctx || !simulationLogData.length) return;
            if (dailyPerformanceChartInstance) dailyPerformanceChartInstance.destroy();
            
            Chart.register(ChartDataLabels);

            const parseTime = (timeStr) => {
                const [time, modifier] = timeStr.split(' ');
                let [hours, minutes] = time.split(':');
                hours = parseInt(hours, 10);
                minutes = parseInt(minutes || '00', 10);
                if (modifier && modifier.toUpperCase() === 'PM' && hours < 12) hours += 12;
                if (modifier && modifier.toUpperCase() === 'AM' && hours === 12) hours = 0;
                return new Date(2000, 0, 1, hours, minutes);
            };

            const chartConfig = {
                type: 'line',
                data: {
                    labels: simulationLogData.map(d => parseTime(d.Time)),
                    datasets: [
                        { label: 'Default Setting', data: [], borderColor: '#f59e0b', pointBackgroundColor: '#f59e0b', tension: 0.1, pointRadius: 5 },
                        { label: 'GA-BMO', data: [], borderColor: '#ef4444', pointBackgroundColor: '#ef4444', tension: 0.1, pointRadius: 5 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                           display: true,
                           color: '#E0E0E0',
                           align: 'top',
                           anchor: 'end',
                           offset: 8,
                           font: {
                            weight: 'bold'
                           },
                           formatter: (value) => value.toFixed(1)
                        },
                        title: { display: true, text: 'Comparison of Power Consumption', color: '#E0E0E0', font: { size: 20, weight: '600' } },
                        legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8, color: 'rgba(224, 224, 224, 0.7)' } }
                    },
                    scales: {
                        x: { type: 'time', time: { unit: 'hour', tooltipFormat: 'h:mm a', displayFormats: { hour: 'h a' } }, grid: { drawBorder: false, color: 'rgba(224, 224, 224, 0.1)' }, ticks: { color: 'rgba(224, 224, 224, 0.7)' } },
                        y: { 
                            title: { display: true, text: 'Total Power Consumption (kW)', color: 'rgba(224, 224, 224, 0.7)', font: {weight: 'bold'} }, 
                            grid: { border: { dash: [4, 4] }, color: 'rgba(224, 224, 224, 0.1)' }, 
                            ticks: { color: 'rgba(224, 224, 224, 0.7)' } 
                        }
                    }
                }
            };
            dailyPerformanceChartInstance = new Chart(ctx, chartConfig);
            
            const playBtn = document.getElementById('play-pause-button');
            const resetBtn = document.getElementById('reset-button');
            const chartData = simulationLogData;
            
            const startAnimation = () => {
                if (isAnimationPlaying) return;
                if (currentDataIndex >= chartData.length) {
                    currentDataIndex = 0;
                    dailyPerformanceChartInstance.data.datasets.forEach(ds => ds.data = []);
                }
                isAnimationPlaying = true;
                playBtn.textContent = 'Pause Simulation';
                animationInterval = setInterval(() => {
                    if (currentDataIndex < chartData.length) {
                        const point = chartData[currentDataIndex];
                        dailyPerformanceChartInstance.data.datasets[0].data.push(parseFloat(point.out_TotalPower_Default));
                        dailyPerformanceChartInstance.data.datasets[1].data.push(parseFloat(point.out_TotalPower_GAMBO));
                        dailyPerformanceChartInstance.update('none'); 
                        currentDataIndex++;
                    } else {
                        stopAnimation(true);
                    }
                }, 500);
            };

            const stopAnimation = (finished = false) => {
                clearInterval(animationInterval);
                isAnimationPlaying = false;
                playBtn.textContent = finished ? 'Replay Simulation' : 'Resume Simulation';
            };

            playBtn.onclick = () => isAnimationPlaying ? stopAnimation() : startAnimation();
            resetBtn.onclick = () => {
                stopAnimation();
                currentDataIndex = 0;
                dailyPerformanceChartInstance.data.datasets.forEach(ds => ds.data = []);
                dailyPerformanceChartInstance.update();
                playBtn.textContent = 'Play Simulation';
            };
            resetBtn.onclick();
        }

        function selectTab(index, element) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            element.classList.add('active');
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('hidden', i !== index);
            });
            if (index === 2 && !dailyPerformanceChartInstance) {
                setupAnimatedChart();
            }
            if (index === 1){
                setupLoadDistributionChart();
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            document.getElementById('mode-switch').addEventListener('change', async (event) => {
                isManualMode = event.target.checked;
                document.getElementById('mode-text').innerText = `Mode: ${isManualMode ? 'Manual Run' : 'Daily Simulation'}`;
                await fetchChillerData();
            });

            await fetchChillerData(); // Initial data fetch
            
            // Initial tab selection
            selectTab(0, document.querySelector('.tab-button'));

            // Setup Gemini Buttons
            document.getElementById('analyze-performance-btn').addEventListener('click', handlePerformanceAnalysis);
            document.getElementById('get-kpi-insights-btn').addEventListener('click', handleKpiInsights);

            setInterval(fetchChillerData, 30000); // Refresh data every 30 seconds
            
            setInterval(async () => {
                demandTable = await fetchCsvData(coolingDemandUrl);
                updateCoolingDemandTableTab();
            }, 60000);
        });
    </script>
</body>
</html>
